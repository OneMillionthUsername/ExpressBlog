<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/components.css">
    <link rel="stylesheet" href="/assets/css/admin.css">
    <title>Blogpost - Sub specie aeternitatis</title>
    <% if (typeof post !== 'undefined' && post && post.id) { %>
    <meta name="post-id" content="<%= post.id %>">
    <% } %>
</head>
<body>
    <%- include('partials/navbar.ejs') %>
    <div class="container-fluid header-section no-min-height">
        <h1 id="main-title" class="main-title">Blogpost lesen</h1>
        <p id="description" class="description">Gedanken über Philosophie, Wissenschaft und AI</p>
        <hr class="header-divider">
    </div>
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="content-area">
                    <div id="blogpost-content">
                        <% if (!post) { %>
                        <div id="loading" class="loading-spinner">
                            <div class="spinner"></div>
                            <p>Lade Blogpost...</p>
                        </div>
                        <% } %>

                        <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
                        <!-- Replaced alert with simple paragraph to avoid duplicate CTAs and confusion -->
                        <p class="text-muted small"><%= errorMessage %></p>
                        <% } else { %>
                        <article id="post-article" class="<%= post ? '' : 'hidden' %>" <% if (typeof post !== 'undefined' && post && post.id) { %> data-post-id="<%= post.id %>" <% } %>>
                            <header class="post-header">
                                <h2 id="title" class="post-title"><%= post ? post.title : '' %></h2>
                                <div id="meta" class="post-meta-info">
                                    <% if (post) { %>
                                        <div class="post-date">Erstellt am <%= new Date(post.created_at).toLocaleDateString('de-DE') %> um <%= new Date(post.created_at).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) %></div>
                                        <% if (post.updated_at && post.updated_at !== post.created_at) { %>
                                            <div class="post-updated">Zuletzt aktualisiert am <%= new Date(post.updated_at).toLocaleDateString('de-DE') %> um <%= new Date(post.updated_at).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) %></div>
                                        <% } %>
                                        <div class="post-reading-time">Lesezeit: ca. <%= Math.ceil((post.content || '').split(' ').filter(Boolean).length / 200) %> min.</div>
                                    <% } %>
                                </div>
                            </header>
                            
                            <div id="content" class="post-content"><% if (post && post.content) { %><%- post.content %><% } %></div>
                            
                            <footer class="post-footer">
                                <div id="tags" class="post-tags-container">
                                    <% if (post && Array.isArray(post.tags) && post.tags.length > 0) { %>
                                        <div class="tags-label">Tags:</div>
                                        <div class="tags-list"><%= post.tags.map(tag => tag).join(' ') %></div>
                                    <% } %>
                                </div>
                            </footer>
                        </article>
                        
                        <!-- Kommentarsystem (partial) -->
                        <% if (post) { %>
                            <%- include('partials/comments.ejs') %>
                        <% } %>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="navigation text-center mt-4">
            <a href="/posts" class="btn btn-outline-primary">Alle Blogposts</a>
            <a href="/" class="btn btn-outline-secondary ml-2">Zur Startseite</a>
            <a href="/createPost" class="btn btn-outline-success ml-2 create-link hidden">Neuen Post erstellen</a>
                <div id="admin-controls" class="mt-15">
                    <% if (typeof isAdmin !== 'undefined' && isAdmin && post && post.id) { %>
                    <button type="button" data-action="delete-post" data-post-id="<%= post.id %>" class="btn admin-delete-btn btn-lg ml-2">
                        Post löschen
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-lg ml-2" data-action="edit-post" data-post-id="<%= post.id %>">
                        <span class="btn-icon">✏️</span>
                        Post bearbeiten
                    </button>
                    <% } %>
                </div>
        </div>
    </div>
    <script src="/vendor/dompurify.min.js"></script>
    <% // Precompute JSON on the server side and escape unsafe sequences to avoid breaking out of the script tag %>
    <% function __safeJson(obj) { try { const s = JSON.stringify(obj); return s.replace(/</g, '\\u003c').replace(/-->/g, '--\\u003e').replace(/\u2028/g, '\\u2028').replace(/\u2029/g, '\\u2029'); } catch (e) { return 'null'; } } %>
    <% const __nonceAttr = (typeof nonce !== 'undefined') ? ' nonce="' + String(nonce) + '"' : '' %>
    <% const __isAdmin = (typeof isAdmin !== 'undefined') ? !!isAdmin : false; %>
    <!-- Expose the server-rendered post via non-executable JSON (no globals) -->
    <% if (typeof post !== 'undefined' && post) { %>
    <script id="server-post" type="application/json"<%- __nonceAttr %>>
        <%- __safeJson(post) %>
    </script>
    <% } %>
                <!-- Expose a minimal server config via non-executable JSON (no globals) -->
                <script id="server-config" type="application/json"<%- __nonceAttr %>>
                    { "isAdmin": <%= __isAdmin ? 'true' : 'false' %> }
                </script>
    <script<%- __nonceAttr %>>
        // Defensive fallback: if the server injected #server-post JSON,
        // remove the loading spinner and ensure the article is visible.
        (function() {
            try {
                var serverPostEl = document.getElementById('server-post');
                if (serverPostEl) {
                    var loadingEl = document.getElementById('loading');
                    if (loadingEl && loadingEl.parentNode) loadingEl.parentNode.removeChild(loadingEl);
                    var postArticle = document.getElementById('post-article');
                    if (postArticle) {
                        postArticle.classList.remove('hidden');
                        postArticle.style.display = 'block';
                    }
                }
            } catch (err) {
                // swallow errors - non-critical
                console.debug('defensive spinner removal failed', err);
            }
        })();
    </script>
    <!-- No inline defensive hiding: spinner should remain visible until content is loaded or an error occurs. 
         If the server rendered the post (`post` exists), the loading container is initially hidden above. -->
    <script src="/assets/js/page-initializers.js" type="module"></script>

</body>
</html>