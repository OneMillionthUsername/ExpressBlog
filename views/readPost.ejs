<% 
    pageTitle = 'Blogpost - Sub specie aeternitatis';
    metaDescription = 'Destillierte Gedanken ...';
    extraHead = typeof post !== 'undefined' && post && post.id ? `<meta name="post-id" content="${post.id}">` : '';
%>
<div class="container-fluid header-section no-min-height">
    <h1 id="main-title" class="main-title">Blogpost lesen</h1>
    <p id="description" class="description">Gedanken über Philosophie, Wissenschaft und AI</p>
    <hr class="header-divider">
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="content-area">
                <div id="blogpost-content">
                    <% if (!post) { %>
                    <div id="loading" class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Lade Blogpost...</p>
                    </div>
                    <% } %>

                    <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
                    <p class="text-muted small"><%= errorMessage %></p>
                    <% } else { %>
                    <article id="post-article" class="<%= post ? '' : 'hidden' %>" <% if (typeof post !== 'undefined' && post && post.id) { %> data-post-id="<%= post.id %>" <% } %>>
                        <header class="post-header">
                            <h2 id="title" class="post-title"><%= post ? post.title : '' %></h2>
                            <div id="meta" class="post-meta-info">
                                <% if (post) { %>
                                    <div class="post-date">Erstellt am <%= new Date(post.created_at).toLocaleDateString('de-DE') %> um <%= new Date(post.created_at).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) %></div>
                                    <% if (post.updated_at && post.updated_at !== post.created_at) { %>
                                        <div class="post-updated">Zuletzt aktualisiert am <%= new Date(post.updated_at).toLocaleDateString('de-DE') %> um <%= new Date(post.updated_at).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) %></div>
                                    <% } %>
                                    <div class="post-reading-time">Lesezeit: ca. <%= Math.ceil((post.content || '').split(' ').filter(Boolean).length / 200) %> min.</div>
                                <% } %>
                            </div>
                        </header>
                        <div id="content" class="post-content"><% if (post && post.content) { %><%- post.content %><% } %></div>
                        <footer class="post-footer">
                            <div id="tags" class="post-tags-container">
                                <% if (post && Array.isArray(post.tags) && post.tags.length > 0) { %>
                                    <div class="tags-label">Tags:</div>
                                    <div class="tags-list">
                                        <% post.tags.forEach(function(tag) { %>
                                            <span class="tag"><%= tag %></span>
                                        <% }); %>
                                    </div>
                                <% } %>
                            </div>
                        </footer>
                    </article>

                    <% if (post) { %>
                        <%- include('partials/comments.ejs') %>
                    <% } %>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <div class="navigation text-center mt-4">
        <a href="/posts" class="btn btn-outline-primary">Alle Blogposts</a>
        <a href="/" class="btn btn-outline-secondary ml-2">Zur Startseite</a>
        <a href="/createPost" class="btn btn-outline-success ml-2 create-link hidden">Neuen Post erstellen</a>
        <div id="admin-controls" class="mt-15">
            <% if (typeof isAdmin !== 'undefined' && isAdmin && post && post.id) { %>
            <form method="POST" action="/blogpost/delete/<%= post.id %>" class="d-inline">
                <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <% } %>
                <button type="submit" class="btn admin-delete-btn btn-lg ml-2" data-confirm="Möchten Sie diesen Beitrag wirklich löschen?">
                    Post löschen
                </button>
            </form>
            <a href="/createPost/<%= post.id %>" class="btn btn-outline-warning btn-lg ml-2">
                <span class="btn-icon">✏️</span>
                Post bearbeiten
            </a>
            <% } %>
        </div>
    </div>
</div>

<% 
function __safeJson(obj) { 
    try { 
        const s = JSON.stringify(obj); 
        return s.replace(/</g, '\\u003c').replace(/-->/g, '--\\u003e').replace(/\u2028/g, '\\u2028').replace(/\u2029/g, '\\u2029'); 
    } catch (e) { return 'null'; } 
}
const __nonceAttr = (typeof nonce !== 'undefined') ? ` nonce="${String(nonce)}"` : '';
extraScripts = '';
if (typeof post !== 'undefined' && post) {
    extraScripts += `<script id="server-post" type="application/json"${__nonceAttr}>${__safeJson(post)}<\/script>`;
}
extraScripts += `<script${__nonceAttr}>
    (function() {
        try {
            var serverPostEl = document.getElementById('server-post');
            if (serverPostEl) {
                var loadingEl = document.getElementById('loading');
                if (loadingEl && loadingEl.parentNode) loadingEl.parentNode.removeChild(loadingEl);
                var postArticle = document.getElementById('post-article');
                if (postArticle) {
                    postArticle.classList.remove('hidden');
                    postArticle.style.display = 'block';
                }
            }
        } catch (err) { console.debug('defensive spinner removal failed', err); }
    })();
<\/script>`;
%>
