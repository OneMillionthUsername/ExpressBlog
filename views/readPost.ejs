<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/components.css">
    <link rel="stylesheet" href="/assets/css/admin.css">
    <title>Blogpost - Sub specie aeternitatis</title>
</head>
<body>
    <%- include('partials/navbar.ejs') %>
    <div class="container-fluid header-section no-min-height">
        <h1 id="main-title" class="main-title">Blogpost lesen</h1>
        <p id="description" class="description">Gedanken Ã¼ber Philosophie, Wissenschaft und AI</p>
        <hr class="header-divider">
    </div>
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="content-area">
                    <div id="blogpost-content">
                        <% if (!post) { %>
                        <div id="loading" class="loading-spinner">
                            <div class="spinner"></div>
                            <p>Lade Blogpost...</p>
                        </div>
                        <% } %>

                        <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
                        <!-- Replaced alert with simple paragraph to avoid duplicate CTAs and confusion -->
                        <p class="text-muted small"><%= errorMessage %></p>
                        <% } else { %>
                        <article id="post-article" class="<%= post ? '' : 'hidden' %>">
                            <header class="post-header">
                                <h2 id="title" class="post-title"><%= post ? post.title : '' %></h2>
                                <div id="meta" class="post-meta-info">
                                    <% if (post) { %>
                                        <div class="post-date">Erstellt am <%= new Date(post.created_at).toLocaleDateString('de-DE') %> um <%= new Date(post.created_at).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) %></div>
                                        <% if (post.updated_at && post.updated_at !== post.created_at) { %>
                                            <div class="post-updated">Zuletzt aktualisiert am <%= new Date(post.updated_at).toLocaleDateString('de-DE') %> um <%= new Date(post.updated_at).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) %></div>
                                        <% } %>
                                        <div class="post-reading-time">Lesezeit: ca. <%= Math.ceil((post.content || '').split(' ').filter(Boolean).length / 200) %> min.</div>
                                    <% } %>
                                </div>
                            </header>
                            
                            <div id="content" class="post-content"><% if (post && post.content) { %><%- post.content %><% } %></div>
                            
                            <footer class="post-footer">
                                <div id="tags" class="post-tags-container">
                                    <% if (post && Array.isArray(post.tags) && post.tags.length > 0) { %>
                                        <div class="tags-label">Tags:</div>
                                        <div class="tags-list"><%= post.tags.map(tag => tag).join(' ') %></div>
                                    <% } %>
                                </div>
                            </footer>
                        </article>
                        
                        <!-- Kommentarsystem (partial) -->
                        <% if (post) { %>
                            <%- include('partials/comments.ejs') %>
                        <% } %>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="navigation text-center mt-4">
            <a href="/posts" class="btn btn-outline-primary">Alle Blogposts</a>
            <a href="/" class="btn btn-outline-secondary ml-2">Zur Startseite</a>
            <a href="/blogpost/create" class="btn btn-outline-success ml-2 create-link hidden">Neuen Post erstellen</a>
            <div id="admin-controls" class="mt-15"></div>
        </div>
    </div>
    <script src="/vendor/dompurify.min.js"></script>
    <% // Precompute JSON on the server side to avoid template parsing issues %>
    <% const __serverPost = JSON.stringify(typeof post !== 'undefined' ? post : null); %>
    <!-- If the server rendered the post, expose it to the client JS so the page can
         show the content without making an extra API request. Use unescaped EJS
         output to inject JSON. post has been converted by the route where needed. -->
    <script nonce="<%= nonce %>">
        window.__SERVER_POST = <%- __serverPost %>;
    </script>
    <script nonce="<%= nonce %>">
        // Defensive fallback: if the server injected the post JSON, remove the loading
        // spinner element and ensure the article is visible. This helps if CSS is stale
        // or if the client-side initializer hasn't run yet.
        (function() {
            try {
                if (window.__SERVER_POST) {
                    const loadingEl = document.getElementById('loading');
                    if (loadingEl && loadingEl.parentNode) loadingEl.parentNode.removeChild(loadingEl);
                    const postArticle = document.getElementById('post-article');
                    if (postArticle) {
                        postArticle.classList.remove('hidden');
                        postArticle.style.display = 'block';
                    }
                }
            } catch (err) {
                // swallow errors - non-critical
                console.debug('defensive spinner removal failed', err);
            }
        })();
    </script>
    <!-- No inline defensive hiding: spinner should remain visible until content is loaded or an error occurs. 
         If the server rendered the post (`post` exists), the loading container is initially hidden above. -->
    <script src="/assets/js/page-initializers.js" type="module"></script>

</body>
</html>