<% 
    pageTitle = 'Archiv - Sub specie aeternitatis';
    metaDescription = 'Archiv älterer Beiträge: Hier sind meine alten und vergangenen Essays und Analysen zu Philosophie, Wissenschaft und so weiter.';
%>
<div class="container-fluid header-section">
    <h1 class="main-title">Archiv</h1>
    <p class="description">Ältere Beiträge - Gedanken aus der Vergangenheit</p>
    <hr class="header-divider">
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="content-area">
                <div id="archivePosts">
                    <% if (typeof posts !== 'undefined' && Array.isArray(posts) && posts.length > 0) { %>
                        <%
                            const grouped = {};
                            posts.forEach(function(post) {
                                const y = new Date(post.created_at).getFullYear();
                                if (!grouped[y]) grouped[y] = [];
                                grouped[y].push(post);
                            });
                            const yearKeys = Object.keys(grouped).sort((a,b) => b - a);
                        %>
                        <% if (typeof archiveYears !== 'undefined' && Array.isArray(archiveYears) && archiveYears.length > 0) { %>
                            <div class="archive-years mb-3">
                                <label for="archive-year-select">Archiv nach Jahr:</label>
                                <div class="btn-group ml-2" role="group" aria-label="Archive years">
                                    <% archiveYears.forEach(function(y) { %>
                                        <a class="btn btn-sm btn-outline-secondary <%= (yearKeys.length === 1 && Number(yearKeys[0]) === Number(y)) ? 'active' : '' %>" href="/blogpost/archive?<%= 'year=' + y %>"><%= y %></a>
                                    <% }); %>
                                </div>
                            </div>
                        <% } %>
                        <% yearKeys.forEach(function(year) { %>
                            <h2 class="archive-year-heading">Beiträge aus dem Jahr <%= year %></h2>
                            <% grouped[year].forEach(function(post) { %>
                                <div class="archive-post-item">
                                    <h3><a class="post-link-style" href="/blogpost/<%= post.slug || ('by-id/' + post.id) %>"><%= post.title %></a></h3>
                                    <p class="post-meta"><%= new Date(post.created_at).toLocaleDateString('de-DE') %></p>
                                    <% if (post.excerpt) { %><div class="post-excerpt"><%= post.excerpt %></div><% } %>
                                </div>
                            <% }); %>
                        <% }); %>
                    <% } else { %>
                        <div class="no-posts-card text-center py-5">
                            <h3 class="mb-2">Keine Archiv-Posts gefunden</h3>
                            <p class="text-muted lead mb-4">Im Archiv wurden keine älteren Blogposts gefunden.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
    <div class="navigation text-center mt-4">
        <a href="/" class="btn btn-outline-primary">Zur Startseite</a>
        <a href="/posts" class="btn btn-outline-secondary ml-2">Aktuelle Posts</a>
    </div>
</div>

<% extraScripts = `
<script${typeof nonce !== 'undefined' ? ' nonce="' + String(nonce) + '"' : ''}>
    (function() {
        try {
            const archiveEl = document.getElementById('archivePosts');
            if (archiveEl && archiveEl.querySelectorAll('.archive-post-item').length > 0) {
                const spinner = archiveEl.querySelector('.loading-spinner');
                if (spinner && spinner.parentNode) spinner.parentNode.removeChild(spinner);
            }
        } catch (err) { /* non-critical */ }
    })();
</script>
`; %>
